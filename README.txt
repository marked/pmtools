Copyright 2014 by telemark of tivocommunitiy.com
License granted under GPL 3 or later.


Usage Examples

Setup environment:
export PATH="~/pmtools/bin:$PATH"

Reorder partition map
--
mkdir sdX
cd sdX

# splits a partition map into individual records
> pmdice /dev/sdX

ls -tr  | grep -v order.txt > order.txt

# combines individual records into a single map, in the order of the input file.
> pmix order.txt > NEW-PM.bin


New Roamio Map From Scratch
--
Create text file in 4 or 5 column format
(use disk order if offsets are unknown)
[line numbers are for illustration only]

> nl part-list.txt 
     1   MP : Apple_partition_map :                    'Apple' :        63 : 1
     2   MP :                 MFS :       'MFS media region 2' : 537225040 
     3   MP :               Image :              'Bootstrap 1' :         8 
     4   MP :               Image :                 'Kernel 1' :         8 
     5   MP :                Ext2 :                   'Root 1' :         8 
     6   MP :               Image :              'Bootstrap 2' :         8 
     7   MP :               Image :                 'Kernel 2' :         8 
     8   MP :                Ext2 :                   'Root 2' :         8 
     9   MP :                Swap :               'Linux swap' :   1048576 
    10   MP :                Ext2 :                     '/var' :   1572864 
    11   MP :                Ext2 :                   'SQLite' :   6291456 
    12   MP :                 MFS :   'MFS application region' :   1638400 
    13   MP :                 MFS : 'MFS application region 2' :   1638400 
    14   MP :                 MFS :         'MFS media region' : 427358320 

Check size for alignment
> cat part-list.txt | cut -d":" -f 4 | divtest  *512 %512  %1024 %4096 %8192 
        N:            *512  %512 %1024 %4096 %8192
       63:           32256     0   512  3584  7680
537225040:    275059220480     0     0     0     0
        8:            4096     0     0     0  4096
        8:            4096     0     0     0  4096
        8:            4096     0     0     0  4096
        8:            4096     0     0     0  4096
        8:            4096     0     0     0  4096
        8:            4096     0     0     0  4096
  1048576:       536870912     0     0     0     0
  1572864:       805306368     0     0     0     0
  6291456:      3221225472     0     0     0     0
  1638400:       838860800     0     0     0     0
  1638400:       838860800     0     0     0     0
427358320:    218807459840     0     0     0     0

Create record files, and propagate autogenerated offset:
> chainexec pcreate part-list.txt
Executing:
pcreate  MP   Apple_partition_map                      'Apple'          63   1 
pcreate  MP                   MFS         'MFS media region 2'   537225040 64
pcreate  MP                 Image                'Bootstrap 1'           8 537225104
pcreate  MP                 Image                   'Kernel 1'           8 537225112
pcreate  MP                  Ext2                     'Root 1'           8 537225120
pcreate  MP                 Image                'Bootstrap 2'           8 537225128
pcreate  MP                 Image                   'Kernel 2'           8 537225136
pcreate  MP                  Ext2                     'Root 2'           8 537225144
pcreate  MP                  Swap                 'Linux swap'     1048576 537225152
pcreate  MP                  Ext2                       '/var'     1572864 538273728
pcreate  MP                  Ext2                     'SQLite'     6291456 539846592
pcreate  MP                   MFS     'MFS application region'     1638400 546138048
pcreate  MP                   MFS   'MFS application region 2'     1638400 547776448
pcreate  MP                   MFS           'MFS media region'   427358320 549414848
Last output: 976773168

Specify the ordering for the map [line numered for illustration]
> nl order.txt 
     1  0
     2  Apple
     3  Bootstrap_1
     4  Kernel_1
     5  Root_1
     6  Bootstrap_2
     7  Kernel_2
     8  Root_2
     9  Linux_swap
    10  _var
    11  MFS_application_region
    12  MFS_media_region
    13  MFS_application_region_2
    14  MFS_media_region_2
    15  SQLite

Mix the records together to form new map
> pmix order.txt > NEW-PM.bin

Write new map (and block0) to disk
> dd if=NEW-PM.bin of=/dev/sdb bs=512 count=15

Overwrite bootpage params:
> echo -ne "root=/dev/sda4\x0" > 4.patch
> hexdump -C 4.patch
> bpatch 0.bin 4.patch

(re)Set guid:
> random16 > 304.patch
> hexdump -C 304.patch
> bpatch 0.bin 304.patch

